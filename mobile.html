<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SanityDash">
    <link rel="apple-touch-icon" href="/assets/favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.png">
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <title>SanityDash</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        body {
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            flex-direction: column;
            padding: 0;
            margin: 0;
        }

        .mobile-container {
            width: 100%;
            height: 100vh;
            height: -webkit-fill-available;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .mobile-input-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .mobile-input {
            width: 100%;
            max-width: 400px;
            padding: 16px 0;
            font-family: var(--font-family);
            font-size: 24px;
            font-weight: 300;
            letter-spacing: var(--letter-spacing);
            color: var(--color-white);
            background: transparent;
            border: none;
            border-bottom: 1px solid #777676;
            outline: none;
            text-align: center;
        }

        .mobile-input::placeholder {
            color: #777676;
        }

        .mobile-actions {
            display: flex;
            gap: 1px;
            width: 100%;
        }

        .mobile-btn {
            flex: 1;
            height: 120px;
            background: var(--color-white);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .mobile-btn img {
            width: 32px;
            height: 32px;
            filter: brightness(0);
            transition: filter 0.3s ease;
        }

        .mobile-btn:active,
        .mobile-btn.recording {
            background: var(--color-accent);
        }

        .mobile-btn:active img,
        .mobile-btn.recording img {
            filter: brightness(0) invert(1);
        }

        .mobile-feedback {
            position: absolute;
            bottom: 140px;
            left: 0;
            right: 0;
            font-family: var(--font-family);
            font-size: 14px;
            font-weight: 300;
            color: #777676;
            text-align: center;
        }

        .mobile-feedback.success {
            color: var(--color-accent);
        }

        .mobile-logo {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <img src="/assets/logo/logo.svg" alt="SanityDash" class="mobile-logo">
        <div class="mobile-input-area">
            <input type="text" class="mobile-input" id="taskInput" placeholder="" autofocus>
        </div>

        <div class="mobile-feedback" id="feedback"></div>

        <div class="mobile-actions">
            <button class="mobile-btn" id="micBtn">
                <img src="/assets/icons/mic.svg" alt="Spraak">
            </button>
            <button class="mobile-btn" id="sendBtn">
                <img src="/assets/icons/arrow-right.svg" alt="Verstuur">
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCaqrEmvJ-3EZ8Tnt4HLFd2gMb-j5rhkA4",
            authDomain: "sanitydash-aff6a.firebaseapp.com",
            projectId: "sanitydash-aff6a",
            storageBucket: "sanitydash-aff6a.firebasestorage.app",
            messagingSenderId: "1096864734708",
            appId: "1:1096864734708:web:6c39d6b6dfb6837da72da1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const taskInput = document.getElementById('taskInput');
        const sendBtn = document.getElementById('sendBtn');
        const micBtn = document.getElementById('micBtn');
        const feedback = document.getElementById('feedback');

        let recognition = null;
        let isRecording = false;
        let contacten = [];

        // Laad contacten bij opstarten
        async function loadContacts() {
            try {
                const docRef = doc(db, 'settings', 'contacts');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    contacten = docSnap.data().contacten || [];
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
            }
        }

        loadContacts();

        // Get tasks from Firebase
        async function getTasks() {
            try {
                const docRef = doc(db, 'tasks', 'main');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
            return {
                inbox: [],
                planning: [],
                bellen: [],
                mailen: []
            };
        }

        // Save tasks to Firebase
        async function saveTasks(tasks) {
            try {
                const docRef = doc(db, 'tasks', 'main');
                await setDoc(docRef, {
                    ...tasks,
                    updatedAt: new Date().toISOString()
                });
                return true;
            } catch (error) {
                console.error('Error saving tasks:', error);
                return false;
            }
        }

        // ===================
        // SLIMME TASK PARSER
        // ===================
        const STOPWOORDEN = new Set([
            'om', 'te', 'de', 'het', 'een', 'voor', 'naar', 'aan', 'met', 'over',
            'van', 'in', 'op', 'bij', 'uit', 'dat', 'die', 'dit', 'dan', 'als',
            'nog', 'wel', 'niet', 'ook', 'maar', 'want', 'dus', 'even', 'nog',
            'er', 'ze', 'hij', 'zij', 'we', 'je', 'ik', 'en', 'of', 'is'
        ]);

        function parseTaskInput(text) {
            const input = text.trim();

            // Detecteer actie-keywords (langste eerst)
            const keywordGroups = [
                { keywords: ['e-mailen', 'emailen', 'mailen', 'e-mail', 'mail'], action: 'mailen' },
                { keywords: ['opbellen', 'bellen', 'bel'], action: 'bellen' },
                { keywords: ['inplannen', 'plannen', 'plan'], action: 'planning' }
            ];

            let actionType = null;
            let matchedKeyword = null;

            for (const group of keywordGroups) {
                for (const kw of group.keywords) {
                    const regex = new RegExp('(^|\\s|,)' + kw + '(\\s|,|\\.|!|$)', 'i');
                    if (regex.test(input)) {
                        actionType = group.action;
                        matchedKeyword = kw;
                        break;
                    }
                }
                if (actionType) break;
            }

            // Detecteer uren (bv. "2 uur", "3u", "6 uren")
            let uren = null;
            const urenMatch = input.match(/(\d+)\s*(?:uu?r(?:en)?|u)\b/i);
            if (urenMatch) {
                const parsedUren = parseInt(urenMatch[1]);
                if ([1, 2, 3, 6].includes(parsedUren)) {
                    uren = parsedUren;
                }
            }

            // === NAAM DETECTIE ===
            // Stap 1: Probeer via contactenlijst
            let matchedContact = null;
            for (const contact of contacten) {
                const escaped = contact.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp('(^|\\s|,)' + escaped + '(\\s|,|\\.|!|$)', 'i');
                if (regex.test(input)) {
                    matchedContact = contact;
                    break;
                }
            }

            // Stap 2: Als geen contactmatch maar wel mailen/bellen keyword,
            // pak het eerste woord dat geen keyword/stopwoord is als naam
            if (!matchedContact && (actionType === 'mailen' || actionType === 'bellen')) {
                const woorden = input.split(/\s+/);
                for (const woord of woorden) {
                    const woordLower = woord.toLowerCase().replace(/[.,!?]/g, '');
                    if (woordLower === matchedKeyword.toLowerCase()) continue;
                    if (STOPWOORDEN.has(woordLower)) continue;
                    if (/^\d+\s*(?:uu?r(?:en)?|u)$/i.test(woord)) continue;
                    if (/^\d+$/.test(woord)) continue;
                    matchedContact = woord.charAt(0).toUpperCase() + woord.slice(1).toLowerCase();
                    break;
                }
            }

            // Bouw de taakbeschrijving: verwijder keyword, naam en uren uit de tekst
            let beschrijving = input;

            if (matchedKeyword) {
                const keywordRegex = new RegExp('(^|\\s|,)' + matchedKeyword + '(\\s|,|\\.|!|$)', 'gi');
                beschrijving = beschrijving.replace(keywordRegex, '$1');
            }

            if (matchedContact) {
                const escaped = matchedContact.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const contactRegex = new RegExp('(^|\\s|,)' + escaped + '(\\s|,|\\.|!|$)', 'gi');
                beschrijving = beschrijving.replace(contactRegex, '$1');
            }

            if (uren) {
                beschrijving = beschrijving.replace(/\d+\s*(?:uu?r(?:en)?|u)\b/i, ' ');
            }

            beschrijving = beschrijving.replace(/^\s*(om\s+te|om|voor|naar|aan|met|over)\s+/i, '');
            beschrijving = beschrijving.replace(/\s+/g, ' ').replace(/^[\s,]+|[\s,]+$/g, '').trim();

            if (beschrijving.length > 0) {
                beschrijving = beschrijving.charAt(0).toUpperCase() + beschrijving.slice(1);
            }

            // === ROUTERING ===

            if (actionType === 'mailen' || actionType === 'bellen') {
                return {
                    category: actionType,
                    task: {
                        naam: matchedContact || '...',
                        taak: beschrijving || 'Taak',
                        completed: false
                    },
                    label: actionType === 'mailen' ? 'Mailen' : 'Bellen'
                };
            }

            if (matchedContact && !actionType) {
                return {
                    category: 'mailen',
                    task: {
                        naam: matchedContact,
                        taak: beschrijving || 'Taak',
                        completed: false
                    },
                    label: 'Mailen'
                };
            }

            if (actionType === 'planning' || uren) {
                return {
                    category: 'planning',
                    task: {
                        titel: beschrijving || input,
                        uren: uren,
                        completed: false
                    },
                    label: 'Planning' + (uren ? ` (${uren}u)` : '')
                };
            }

            // Fallback: inbox
            return {
                category: 'inbox',
                task: {
                    titel: input,
                    completed: false
                },
                label: 'Inbox'
            };
        }

        // Add task met slimme routing
        async function addTask(text) {
            if (!text.trim()) return;

            feedback.textContent = 'Opslaan...';

            // Zorg dat contacten geladen zijn
            if (contacten.length === 0) {
                await loadContacts();
            }

            const tasks = await getTasks();
            const parsed = parseTaskInput(text);

            if (!tasks[parsed.category]) tasks[parsed.category] = [];
            tasks[parsed.category].push(parsed.task);

            const success = await saveTasks(tasks);

            taskInput.value = '';

            if (success) {
                showFeedback(parsed.label + ' +');
            } else {
                showFeedback('Fout bij opslaan');
            }
        }

        function showFeedback(message) {
            feedback.textContent = message;
            feedback.classList.add('success');
            setTimeout(() => {
                feedback.textContent = '';
                feedback.classList.remove('success');
            }, 2000);
        }

        // Send button - blur input first to dismiss keyboard
        sendBtn.addEventListener('click', () => {
            taskInput.blur();
            addTask(taskInput.value);
        });

        // Enter key
        taskInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                taskInput.blur();
                addTask(taskInput.value);
            }
        });

        // Speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'nl-NL';
            recognition.continuous = false;
            recognition.interimResults = true;

            recognition.onstart = () => {
                isRecording = true;
                micBtn.classList.add('recording');
                feedback.textContent = 'Luisteren...';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                taskInput.value = transcript;
            };

            recognition.onend = () => {
                isRecording = false;
                micBtn.classList.remove('recording');
                feedback.textContent = '';
            };

            recognition.onerror = (event) => {
                isRecording = false;
                micBtn.classList.remove('recording');
                console.log('Speech error:', event.error);
                if (event.error === 'not-allowed') {
                    feedback.textContent = 'Microfoon niet toegestaan';
                } else if (event.error === 'no-speech') {
                    feedback.textContent = 'Geen spraak gedetecteerd';
                } else if (event.error === 'aborted') {
                    feedback.textContent = '';
                } else if (event.error === 'network') {
                    feedback.textContent = 'Netwerkfout';
                } else if (event.error === 'service-not-allowed') {
                    feedback.textContent = 'Spraak niet beschikbaar';
                } else {
                    feedback.textContent = 'Fout: ' + event.error;
                }
            };

            micBtn.addEventListener('click', () => {
                if (isRecording) {
                    recognition.stop();
                } else {
                    recognition.start();
                    taskInput.blur();
                }
            });
        } else {
            micBtn.style.display = 'none';
            feedback.textContent = 'Spraak niet ondersteund';
        }
    </script>
</body>
</html>
